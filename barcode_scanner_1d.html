<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>一維條碼掃描器 (QuaggaJS)</title>

<script src="https://unpkg.com/quagga@0.12.1/dist/quagga.min.js"></script>

<style>
body {
	font-family: Arial, sans-serif;
	margin: 0;
	padding: 20px;
	text-align: center;
	background-color: #f4f7f9;
}

.container {
	max-width: 600px;
	margin: auto;
	background-color: #ffffff;
	padding: 20px;
	border-radius: 8px;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}
/* 定義 Quagga 畫面的顯示區域 */
#interactive.viewport {
	width: 100%;
	height: 300px; /* 設定一個固定的高度 */
	overflow: hidden;
	border: 2px solid #ccc;
	border-radius: 4px;
	margin-bottom: 20px;
}
/* Quagga 會在 Viewport 內創建一個 Canvas 和 Video 元素 */
#interactive.viewport>canvas, #interactive.viewport>video {
	width: 100%;
	height: 100%;
	object-fit: cover; /* 確保影片內容填滿容器 */
}

#result {
	margin-top: 20px;
	padding: 15px;
	min-height: 50px;
	background-color: #e6f7ff;
	border: 1px solid #91d5ff;
	border-radius: 4px;
	text-align: left;
}

#result b {
	font-weight: bold;
	color: #0050b3;
}
</style>
</head>
<body>

	<div class="container">
		<h2>條碼掃描器 (支援一維條碼)</h2>
		<p>請將 EAN, Code 128 等一維條碼對準下方的掃描框。</p>

		<div id="interactive" class="viewport"></div>

		<div id="result">
			<b>狀態:</b> 等待啟動...
		</div>
	</div>

	<script>
document.addEventListener('DOMContentLoaded', (event) => {
    const resultElement = document.getElementById('result');
    let isScanning = true;

    // 1. Quagga 初始化設定
    Quagga.init({
        inputStream : {
            name : "Live",
            type : "LiveStream",
            target: document.querySelector('#interactive'), // 將影片串流導向此容器
            constraints: {
                width: 640,
                height: 480,
                facingMode: "environment" // 優先使用後置鏡頭
            },
        },
        decoder : {
            // 設定要支援的條碼類型 (這裡只列出常見的一維條碼)
            readers : [
                "ean_reader",
                "ean_8_reader",
            ],
            // ✨ 新增校驗碼檢查
            multiple: false, // 一次只找一個條碼
            // 確保 EAN/UPC 必須通過校驗碼驗證
            "ean_reader": {
                "config": {
                    "supplemental": "auto",
                    "verifyChecksum": true // 啟用校驗碼檢查
                }
            }
        },
        // 額外的設定，例如頻率、畫面處理等
        locator: {
            patchSize: "medium", // 設置檢測條碼的區域大小 (可選 "x-small", "small", "medium", "large")
            halfSample: true, // 減少採樣，提高速度
            numOfWorkers: 2,     // 提高工作執行緒數量，以加速圖像處理 (建議設定 1 或 2)
            locate: true         // 確保開啟條碼定位功能
        },
        frequency: 10,           // 【優化點 3：降低處理頻率】 
                             // 預設是 5 (次/秒)。如果設為 10 速度會快一點，但如果硬體效能不足，反而會導致畫面卡頓和讀取錯誤。請嘗試 5 或 10。
        //debug: {
            //showCanvas: true, // ⚠️ 設為 true 可以在掃描時顯示綠色線框，方便調整鏡頭
            //showPatches: false
        //}
    }, function(err) {
        if (err) {
            // 初始化失敗
            console.error("Quagga 初始化失敗:", err);
            resultElement.innerHTML = `
                <b>❌ 啟動錯誤:</b> 無法啟動相機。
                <br>
                <span style="color:red;">請確認相機權限，並在 HTTP/HTTPS 環境下運行。錯誤: ${err.name || err.message}</span>
            `;
            return
        }
        // 初始化成功，開始掃描
        Quagga.start();
        resultElement.innerHTML = `<b>狀態:</b> 相機啟動成功，等待條碼進入視窗...`;
    });

    // 2. 處理偵測到的條碼 (即時處理)
    Quagga.onDetected(function(data) {
    	if (!isScanning) return; 

    	// 檢查是否有有效的開始和結束定位，這代表了更高的準確度
    	if (data.codeResult.start && data.codeResult.end) {
        
        	// ✨ 新增準確度檢查
        	// 注意：QuaggaJS 沒有統一的 confidence 數值，我們利用定位資訊來間接判斷
        	// 只有當讀取結果有明確的起點和終點時才接受
        
        	const code = data.codeResult.code;
        	const format = data.codeResult.format;

        	// ... (後續的停止和顯示結果邏輯保持不變)
        	Quagga.stop();
        	isScanning = false;

        	resultElement.innerHTML = `
            	<b>✅ 掃描成功結果:</b> ${code}
            	<br>
            	<b>條碼類型:</b> ${format}
            	<button onclick="restartScanner()" style="margin-left: 10px;">重新掃描</button>
        	`;
        	resultElement.style.backgroundColor = '#f6ffed';
        	resultElement.style.borderColor = '#b7eb8f';
        
        	console.log("偵測到條碼:", code, format);
        
    	} else {
        	// 如果定位資訊不完整，則不處理該結果，繼續掃描
        	console.log("偵測到條碼，但準確度不足，繼續掃描...");
    	}
	});

    // 3. 重新啟動掃描函式
    window.restartScanner = function() {
        Quagga.start();
        isScanning = true;
        resultElement.innerHTML = `<b>狀態:</b> 重新開始掃描...`;
        resultElement.style.backgroundColor = '#e6f7ff';
        resultElement.style.borderColor = '#91d5ff';
    }
});
</script>

</body>

</html>
