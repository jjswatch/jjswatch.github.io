<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>搜尋結果｜GoodDeal 商品比價</title>
    <link rel="manifest" href="manifest.json">
    <style>
        /* 繼承您的 CSS 並微調優化 */
        body { font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif; margin: 0; background: #fdfdfd; color: #333; line-height: 1.5; }
        nav { border-bottom: 1px solid #eee; position: sticky; top: 0; background: #fff; z-index: 100; }
        .nav-container { max-width: 1100px; margin: auto; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 20px; font-weight: bold; cursor: pointer; }
        .nav-links { list-style: none; display: flex; gap: 20px; margin: 0; padding: 0; align-items: center; }
        .nav-links a { text-decoration: none; color: #333; font-size: 15px; }
        #navUser { font-size: 14px; color: #666; }

        .hamburger { display: none; font-size: 24px; cursor: pointer; }

        @media (max-width: 768px) {
            .nav-links { display: none; flex-direction: column; background: #fff; position: absolute; top: 60px; right: 20px; width: 160px; border: 1px solid #eee; border-radius: 10px; padding: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
            .nav-links.active { display: flex; }
            .hamburger { display: block; }
        }

        .hero { background: #f7f7f7; padding: 40px 20px; text-align: center; }
        .hero h2 { margin-top: 0; font-size: 24px; color: #222; }
        .search-box { max-width: 480px; margin: auto; display: flex; gap: 10px; }
        .search-box input { flex: 1; padding: 12px 16px; border-radius: 10px; border: 1px solid #ccc; font-size: 16px; outline: none; transition: 0.3s; }
        .search-box input:focus { border-color: #000; }
        .search-box button { padding: 12px 24px; border: none; border-radius: 10px; background: black; color: white; cursor: pointer; font-size: 16px; transition: 0.2s; }
        .search-box button:hover { opacity: 0.8; }

        #resultList { max-width: 1100px; margin: 30px auto; padding: 0 20px; list-style: none; display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        .item { background: white; border-radius: 16px; padding: 16px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.05); text-align: center; transition: 0.3s; border: 1px solid #f9f9f9; }
        .item:hover { transform: translateY(-5px); box-shadow: 0 6px 18px rgba(0, 0, 0, 0.1); }
        .item img { width: 100%; height: 160px; object-fit: cover; border-radius: 12px; margin-bottom: 12px; background: #f0f0f0; }
        .item-name { font-size: 15px; font-weight: 500; height: 42px; overflow: hidden; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; margin-bottom: 8px; }
        .price { color: #d32f2f; font-size: 18px; font-weight: bold; margin: 8px 0; }
        .price::before { content: "$"; font-size: 14px; margin-right: 2px; }
        .item a { display: block; margin-top: 10px; padding: 8px; background: #000; color: #fff; border-radius: 8px; text-decoration: none; font-size: 14px; transition: 0.2s; }
        
        .loading { grid-column: 1 / -1; text-align: center; padding: 50px; color: #999; }
        footer { text-align: center; padding: 40px 20px; border-top: 1px solid #eee; color: #888; font-size: 14px; }
    </style>
</head>

<body>

<nav>
    <div class="nav-container">
        <div class="logo" onclick="location.href='index.html'">GoodDeal</div>
        <div class="hamburger" onclick="toggleMenu()">☰</div>
        <ul class="nav-links" id="navMenu">
            <li><span id="navUser"></span></li>
            <li><a href="index.html">首頁</a></li>
            <li id="navLogin"><a href="login.html">登入</a></li>
            <li id="navLogout" style="display:none;"><a href="#" onclick="logout()">登出</a></li>
        </ul>
    </div>
</nav>

<section class="hero">
    <h2 id="searchTitle">搜尋結果</h2>
    <div class="search-box">
        <input id="keyword" placeholder="輸入商品名稱或條碼" autocomplete="off" />
        <button onclick="goSearch()">搜尋</button>
    </div>
</section>

<ul id="resultList">
    <div class="loading">正在為您找尋好物...</div>
</ul>

<footer>© 2025 商品比價平台 GoodDeal </footer>

<script src="js/mock-products.js"></script>
<script src="js/auth.js"></script>
<script src="js/api.js"></script>

<script>
/* ========================
   基礎設定與 UI
======================== */
const $ = id => document.getElementById(id);
const getParam = key => new URLSearchParams(location.search).get(key);

// 初始化登入狀態
(function initUser() {
    const user = typeof getCurrentUser === 'function' ? getCurrentUser() : null;
    if (user) {
        $("navUser").textContent = `你好，${user.username}`;
        $("navLogin").style.display = "none";
        $("navLogout").style.display = "inline";
    }
})();

function toggleMenu() { $("navMenu").classList.toggle("active"); }

// 支援 Enter 鍵搜尋
$("keyword").addEventListener("keypress", e => {
    if (e.key === "Enter") goSearch();
});

/* ========================
   搜尋邏輯
======================== */
function goSearch() {
    const key = $("keyword").value.trim();
    if (!key) return;

    // 判斷條碼 (8-20碼數字)
    if (/^\d{8,20}$/.test(key)) {
        location.href = `search.html?barcode=${key}`;
    } else {
        location.href = `search.html?q=${encodeURIComponent(key)}`;
    }
}

/* ========================
   資料渲染
======================== */
function renderProducts(list, title = "搜尋結果") {
    $("searchTitle").textContent = title;
    
    if (!list || list.length === 0) {
        $("resultList").innerHTML = `<li class="loading">查無相關商品，換個關鍵字試試看？</li>`;
        return;
    }

    $("resultList").innerHTML = list.map(p => `
        <li class="item">
            <img src="${p.imageUrl || 'assets/placeholder.png'}" alt="${p.productName}" onerror="this.src='assets/placeholder.png'">
            <div class="item-name">${p.brand ? `${p.brand} ` : ""}${p.productName}</div>
            <a href="product.html?id=${p.productId}">查看商品</a>
        </li>
    `).join("");
}

// 從比價清單過濾出唯一商品
function uniqueProductsFromPrices(priceList) {
    const map = new Map();
    priceList.forEach(item => {
        const p = item.product;
        if (!map.has(p.productId)) {
            // 可順便把價格帶入商品物件
            p.minPrice = item.price; 
            map.set(p.productId, p);
        }
    });
    return Array.from(map.values());
}

/* ========================
   主初始化流程
======================== */
async function initPage() {
    try {
        // 1. 條碼搜尋
        const barcode = getParam("barcode");
        if (barcode) {
            $("keyword").value = barcode;
            if (location.hostname.includes("github.io")) {
                const result = MOCK_PRODUCTS.filter(p => p.barcode === barcode);
                renderProducts(result, `條碼搜尋：${barcode}`);
            } else {
                const list = await apiGetPublic(`/products/barcode?code=${barcode}`);
                renderProducts(list, `條碼搜尋：${barcode}`);
            }
            return;
        }

        // 2. 商店搜尋
        const storeId = getParam("store");
        if (storeId) {
            const list = await apiGetPublic(`/prices/group/${storeId}`);
            const products = uniqueProductsFromPrices(list);
            renderProducts(products, `商店專區`); // 實務上可根據 ID 獲取商店名
            return;
        }

        // 3. 分類搜尋
        const catId = getParam("cat");
        if (catId) {
            const list = await apiGetPublic(`/products/category/${catId}`);
            renderProducts(list, `分類搜尋`);
            return;
        }

        // 4. 關鍵字搜尋
        const keyword = getParam("q");
        if (keyword) {
            $("keyword").value = keyword;
            const list = await apiGetPublic(`/products/search?keyword=${encodeURIComponent(keyword)}`);
            renderProducts(list, `關鍵字：${keyword}`);
            return;
        }
        
        // 若無參數
        $("resultList").innerHTML = `<li class="loading">請輸入關鍵字開始搜尋</li>`;

    } catch (err) {
        console.error("初始化失敗", err);
        $("resultList").innerHTML = `<li class="loading" style="color:red;">連線失敗，請檢查網路狀態</li>`;
    }
}

// 執行
initPage();

// Service Worker 註冊 (保持原樣)
if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
        navigator.serviceWorker.register("/service-worker.js").catch(console.error);
    });
}
</script>

</body>
</html>